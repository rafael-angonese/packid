<?php

$listaDDD = array(
    [
        "estado" => "São Paulo", "uf" => "SP", "ddd" => 11
    ],
    [
        "estado" => "São José dos Campos", "uf" => "SP", "ddd" => 12
    ],
    [
        "estado" => "Santos", "uf" => "SP", "ddd" => 13
    ],
    [
        "estado" => "Bauru", "uf" => "SP", "ddd" => 14
    ],
    [
        "estado" => "Sorocaba", "uf" => "SP", "ddd" => 15
    ],
    [
        "estado" => "Ribeirão Preto", "uf" => "SP", "ddd" => 16
    ],
    [
        "estado" => "São José do Rio Preto", "uf" => "SP", "ddd" => 17
    ],
    [
        "estado" => "Presidente Prudente", "uf" => "SP", "ddd" => 18
    ],
    [
        "estado" => "Campinas", "uf" => "SP", "ddd" => 19
    ],
    [
        "estado" => "Rio de Janeiro", "uf" => "RJ", "ddd" => 21
    ],
    [
        "estado" => "Campos dos Goytacazes", "uf" => "RJ", "ddd" => 22
    ],
    [
        "estado" => "Volta Redonda", "uf" => "RJ", "ddd" => 24
    ],
    [
        "estado" => "Vila Velha/Vitória", "uf" => "ES", "ddd" => 27
    ],
    [
        "estado" => "Cachoeiro de Itapemirim", "uf" => "ES", "ddd" => 28
    ],
    [
        "estado" => "Belo Horizonte", "uf" => "MG", "ddd" => 31
    ],
    [
        "estado" => "Juiz de Fora", "uf" => "MG", "ddd" => 32
    ],
    [
        "estado" => "Governador Valadares", "uf" => "MG", "ddd" => 33
    ],
    [
        "estado" => "Uberlândia", "uf" => "MG", "ddd" => 34
    ],
    [
        "estado" => "Poços de Caldas", "uf" => "MG", "ddd" => 35
    ],
    [
        "estado" => "Divinópolis", "uf" => "MG", "ddd" => 37
    ],
    [
        "estado" => "Montes Claros", "uf" => "MG", "ddd" => 38
    ],
    [
        "estado" => "Curitiba", "uf" => "PR", "ddd" => 41
    ],
    [
        "estado" => "Ponta Grossa", "uf" => "PR", "ddd" => 42
    ],
    [
        "estado" => "Londrina", "uf" => "PR", "ddd" => 43
    ],
    [
        "estado" => "Maringá", "uf" => "PR", "ddd" => 44
    ],
    [
        "estado" => "Foz do Iguaçú", "uf" => "PR", "ddd" => 45
    ],
    [
        "estado" => "Francisco Beltrão/Pato Branco", "uf" => "PR", "ddd" => 46
    ],
    [
        "estado" => "Joinville", "uf" => "SC", "ddd" => 47
    ],
    [
        "estado" => "Florianópolis", "uf" => "SC", "ddd" => 48
    ],
    [
        "estado" => "Chapecó", "uf" => "SC", "ddd" => 49
    ],
    [
        "estado" => "Porto Alegre", "uf" => "RS", "ddd" => 51
    ],
    [
        "estado" => "Pelotas", "uf" => "RS", "ddd" => 53
    ],
    [
        "estado" => "Caxias do Sul", "uf" => "RS", "ddd" => 54
    ],
    [
        "estado" => "Santa Maria", "uf" => "RS", "ddd" => 55
    ],
    [
        "estado" => "Brasília", "uf" => "DF", "ddd" => 61
    ],
    [
        "estado" => "Goiânia", "uf" => "GO", "ddd" => 62
    ],
    [
        "estado" => "Palmas", "uf" => "TO", "ddd" => 63
    ],
    [
        "estado" => "Rio Verde", "uf" => "GO", "ddd" => 64
    ],
    [
        "estado" => "Cuiabá", "uf" => "MT", "ddd" => 65
    ],
    [
        "estado" => "Rondonópolis", "uf" => "MT", "ddd" => 66
    ],
    [
        "estado" => "Campo Grande", "uf" => "MS", "ddd" => 67
    ],
    [
        "estado" => "Rio Branco", "uf" => "AC", "ddd" => 68
    ],
    [
        "estado" => "Porto Velho", "uf" => "RO", "ddd" => 69
    ],
    [
        "estado" => "Salvador", "uf" => "BA", "ddd" => 71
    ],
    [
        "estado" => "Ilhéus", "uf" => "BA", "ddd" => 73
    ],
    [
        "estado" => "Juazeiro", "uf" => "BA", "ddd" => 74
    ],
    [
        "estado" => "Feira de Santana", "uf" => "BA", "ddd" => 75
    ],
    [
        "estado" => "Barreiras", "uf" => "BA", "ddd" => 77
    ],
    [
        "estado" => "Aracaju", "uf" => "SE", "ddd" => 79
    ],
    [
        "estado" => "Recife", "uf" => "PE", "ddd" => 81
    ],
    [
        "estado" => "Maceió", "uf" => "AL", "ddd" => 82
    ],
    [
        "estado" => "João Pessoa", "uf" => "PB", "ddd" => 83
    ],
    [
        "estado" => "Natal", "uf" => "RN", "ddd" => 84
    ],
    [
        "estado" => "Fortaleza", "uf" => "CE", "ddd" => 85
    ],
    [
        "estado" => "Teresina", "uf" => "PI", "ddd" => 86
    ],
    [
        "estado" => "Petrolina", "uf" => "PE", "ddd" => 87
    ],
    [
        "estado" => "Juazeiro do Norte", "uf" => "CE", "ddd" => 88
    ],
    [
        "estado" => "Picos", "uf" => "PI", "ddd" => 89
    ],
    [
        "estado" => "Belém", "uf" => "PA", "ddd" => 91
    ],
    [
        "estado" => "Manaus", "uf" => "AM", "ddd" => 92
    ],
    [
        "estado" => "Santarém", "uf" => "PA", "ddd" => 93
    ],
    [
        "estado" => "Marabá", "uf" => "PA", "ddd" => 94
    ],
    [
        "estado" => "Boa Vista", "uf" => "PR", "ddd" => 95
    ],
    [
        "estado" => "Macapá", "uf" => "AP", "ddd" => 96
    ],
    [
        "estado" => "Coari", "uf" => "AM", "ddd" => 97
    ],
    [
        "estado" => "São Luís", "uf" => "MA", "ddd" => 98
    ],
    [
        "estado" => "Imperatriz", "uf" => "MA", "ddd" => 99
    ]
);

$quantidade = array(
    [
        "uf" => "TO", "quantidade" => 0
    ],
    [
        "uf" => "BA", "quantidade" => 0
    ],
    [
        "uf" => "SE", "quantidade" => 0
    ],
    [
        "uf" => "PE", "quantidade" => 0
    ],
    [
        "uf" => "AL", "quantidade" => 0
    ],
    [
        "uf" => "RN", "quantidade" => 0
    ],
    [
        "uf" => "CE", "quantidade" => 0
    ],
    [
        "uf" => "PI", "quantidade" => 0
    ],
    [
        "uf" => "MA", "quantidade" => 0
    ],
    [
        "uf" => "AP", "quantidade" => 0
    ],
    [
        "uf" => "PA", "quantidade" => 0
    ],
    [
        "uf" => "RR", "quantidade" => 0
    ],
    [
        "uf" => "AM", "quantidade" => 0
    ],
    [
        "uf" => "AC", "quantidade" => 0
    ],
    [
        "uf" => "RO", "quantidade" => 0
    ],
    [
        "uf" => "MT", "quantidade" => 0
    ],
    [
        "uf" => "MS", "quantidade" => 0
    ],
    [
        "uf" => "GO", "quantidade" => 0
    ],
    [
        "uf" => "PR", "quantidade" => 0
    ],
    [
        "uf" => "SC", "quantidade" => 0
    ],
    [
        "uf" => "RS", "quantidade" => 0
    ],
    [
        "uf" => "SP", "quantidade" => 0
    ],
    [
        "uf" => "MG", "quantidade" => 0
    ],
    [
        "uf" => "RJ", "quantidade" => 0
    ],
    [
        "uf" => "ES", "quantidade" => 0
    ],
    [
        "uf" => "DF", "quantidade" => 0
    ],
    [
        "uf" => "PB", "quantidade" => 0
    ]
);


try {
    $dbpg = new PDO("pgsql:host=localhost;dbname=packid", "postgres", "root");

    $sqlTelefones = "select telefone from telefone_alertas;";

    $telefones = array();
    $pdoStatement = $dbpg->query($sqlTelefones);
    while ($row = $pdoStatement->fetch(PDO::FETCH_ASSOC)) {
        $telefone = $row['telefone'];

        $parte = substr($telefone, 2, 2);

        $keyListaDDD = array_search($parte, array_column($listaDDD, 'ddd'));

        $uf = $listaDDD[$keyListaDDD]['uf'];

        $keyQuantidade = array_search($uf, array_column($quantidade, 'uf'));

        $quantidade[$keyQuantidade]['quantidade']++;
    }

    http_response_code(200);
} catch (PDOException $e) {
    $quantidade = ["error" => "error"];
    http_response_code(400);
}

header('Content-Type: application/json');
echo json_encode($quantidade);
